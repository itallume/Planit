{% extends 'global/base.html' %}
{% block titulo %}Ambientes{% endblock %}
{% block content %}

<style>
    .container-ambientes {
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 100%;
        padding: 40px 20px;
    }

    .page-header {
        display: flex;
        width: 100%;
        justify-content: space-around;
        align-items: center;
        margin-bottom: 40px;
        gap: 40px;
    }

    .header-text h1 {
        font-size: 2rem;
        color: var(--text-light);
        margin: 0 0 12px 0;
        font-weight: 700;
    }

    .header-text p {
        margin: 0;
        color: var(--green-light);
        font-size: 1.05rem;
        opacity: 0.9;
    }

    .btn-novo {
        background-color: var(--primary-orange);
        color: white;
        padding: 12px 24px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        transition: transform 0.1s, opacity 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 4px rgba(242, 135, 5, 0.3);
        white-space: nowrap;
    }

    .btn-novo:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }

    .ambientes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px;
        width: 80%;
    }

    .ambiente-card {
        background: #1a1a16;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.3);
        border: 1px solid rgba(163, 204, 171, 0.15);
        display: flex;
        flex-direction: column;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .ambiente-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(242, 104, 0, 0.2);
        border-color: rgba(242, 104, 0, 0.4);
    }

    .card-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }

    .card-titulo {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-light);
        margin: 0;
    }
    
    .card-actions {
        display: flex;
        gap: 10px;
    }

    .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: rgba(163, 204, 171, 0.6);
        transition: color 0.2s;
    }

    .icon-btn:hover {
        color: var(--green-light);
    }
    
    .icon-btn.delete:hover {
        color: var(--status-delayed);
    }

    .stats-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
    }

    .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.8);
    }

    .stat-label {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stat-icon {
        width: 18px;
        height: 18px;
        stroke-width: 2.5;
    }
    
    .concluidas { color: var(--status-completed); }
    .pendentes { color: var(--status-pending); }
    .atrasadas { color: var(--status-delayed); }

    .stat-value {
        font-weight: 600;
    }

    .stat-value.concluidas-val { color: var(--status-completed); }
    .stat-value.pendentes-val { color: var(--status-pending); }
    .stat-value.atrasadas-val { color: var(--status-delayed); }

    .card-footer {
        margin-top: auto;
        padding-top: 16px;
        border-top: 1px solid rgba(163, 204, 171, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        color: var(--text-light);
    }
    
    /* Modal Form Styles */
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 6px;
        color: var(--text-dark);
        font-weight: 600;
    }
    
    .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 1rem;
        color: var(--text-dark);
        background: white;
    }
    
    .form-group input:focus {
        outline: none;
        border-color: var(--green-medium);
        box-shadow: 0 0 0 2px rgba(52, 103, 92, 0.2);
    }
    
    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
    }
    
    .btn-cancelar {
        background: transparent;
        color: var(--text-dark);
        border: 1px solid #e2e8f0;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }
    
    .btn-cancelar:hover {
        background: #f5f5f5;
    }
    
    .btn-salvar {
        background: var(--primary-orange);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px;
        background: #1a1a16;
        border-radius: 12px;
        color: rgba(163, 204, 171, 0.7);
        border: 2px dashed rgba(163, 204, 171, 0.3);
    }

</style>

<div class="container-ambientes">
    <div class="page-header">
        <div class="header-text">
            <h1>Ambientes</h1>
            <p>Gerencie os ambientes e suas atividades</p>
        </div>
        <button onclick="abrirModalAmbiente()" class="btn-novo">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Novo Ambiente
        </button>
    </div>

    {% if ambientes %}
        <div class="ambientes-grid">
            {% for ambiente in ambientes %}
            <div class="ambiente-card">
                <div class="card-top">
                    <h3 class="card-titulo">{{ ambiente.nome }}</h3>
                    <div class="card-actions">
                        <!-- View -->
                        <a href="{% url 'atividades_por_ambiente' ambiente.id %}" class="icon-btn" title="Ver Detalhes">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </a>
                        <!-- Edit -->
                        <button onclick="abrirModalEditar({{ ambiente.id }}, '{{ ambiente.nome|escapejs }}', '{{ ambiente.tema|escapejs }}')" class="icon-btn" title="Editar">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <!-- Delete -->
                        <a href="{% url 'deletar_ambiente' ambiente.id %}" class="icon-btn delete" title="Excluir">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </a>
                    </div>
                </div>

                <div class="stats-list">
                    <div class="stat-row">
                        <span class="stat-label concluidas">
                            <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            Concluídas
                        </span>
                        <span class="stat-value concluidas-val">{{ ambiente.num_concluidas }}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label pendentes">
                            <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            Pendentes
                        </span>
                        <span class="stat-value pendentes-val">{{ ambiente.num_pendentes }}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label atrasadas">
                            <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                            Atrasadas
                        </span>
                        <span class="stat-value atrasadas-val">{{ ambiente.num_atrasadas }}</span>
                    </div>
                </div>

                <div class="card-footer">
                    <span>Total</span>
                    <span>{{ ambiente.num_atividades }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#cbd5e0" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 16px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            <p>Nenhum ambiente encontrado.</p>
            <button onclick="abrirModalAmbiente()" class="btn-novo" style="margin-top: 10px;">Criar Primeiro Ambiente</button>
        </div>
    {% endif %}
</div>

<!-- Modal Criar Ambiente -->
<div id="modalAmbiente" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color: var(--text-dark); margin-top: 0; margin-bottom: 20px;">Criar Novo Ambiente</h3>
        <form method="POST" action="{% url 'criar_ambiente' %}" id="formAmbiente">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_nome">Nome do Ambiente</label>
                <input type="text" name="nome" id="id_nome" required placeholder="Ex: Marketing, Vendas...">
                <div id="error_nome" class="error-message" style="color: #e53e3e; font-size: 0.85rem; margin-top: 4px;"></div>
            </div>
            <div class="form-group">
                <label for="id_tema">Tema (Opcional)</label>
                <input type="text" name="tema" id="id_tema" placeholder="Ex: Azul, Escritório...">
                <div id="error_tema" class="error-message" style="color: #e53e3e; font-size: 0.85rem; margin-top: 4px;"></div>
            </div>
            <div class="modal-buttons">
                <button type="button" onclick="fecharModalAmbiente()" class="btn-cancelar">Cancelar</button>
                <button type="submit" class="btn-salvar">Salvar Ambiente</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar Ambiente -->
<div id="modalEditarAmbiente" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color: var(--text-dark); margin-top: 0; margin-bottom: 20px;">Editar Ambiente</h3>
        <form method="POST" id="formEditarAmbiente">
            {% csrf_token %}
            <input type="hidden" id="editar_ambiente_id" name="ambiente_id">
            <div class="form-group">
                <label for="editar_nome">Nome do Ambiente</label>
                <input type="text" name="nome" id="editar_nome" required>
                <div id="editar_error_nome" class="error-message" style="color: #e53e3e; font-size: 0.85rem; margin-top: 4px;"></div>
            </div>
            <div class="form-group">
                <label for="editar_tema">Tema</label>
                <input type="text" name="tema" id="editar_tema">
                <div id="editar_error_tema" class="error-message" style="color: #e53e3e; font-size: 0.85rem; margin-top: 4px;"></div>
            </div>
            <div class="modal-buttons">
                <button type="button" onclick="fecharModalEditar()" class="btn-cancelar">Cancelar</button>
                <button type="submit" class="btn-salvar">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<script>
    function abrirModalAmbiente() {
        document.getElementById('modalAmbiente').style.display = 'flex';
        document.getElementById('id_nome').focus();
    }
    
    function fecharModalAmbiente() {
        document.getElementById('modalAmbiente').style.display = 'none';
        document.getElementById('formAmbiente').reset();
        document.getElementById('error_nome').textContent = '';
        document.getElementById('error_tema').textContent = '';
    }
    
    function abrirModalEditar(id, nome, tema) {
        document.getElementById('editar_ambiente_id').value = id;
        document.getElementById('editar_nome').value = nome;
        document.getElementById('editar_tema').value = tema;
        document.getElementById('formEditarAmbiente').action = `/ambiente/${id}/editar/`;
        document.getElementById('modalEditarAmbiente').style.display = 'flex';
        document.getElementById('editar_nome').focus();
    }
    
    function fecharModalEditar() {
        document.getElementById('modalEditarAmbiente').style.display = 'none';
        document.getElementById('formEditarAmbiente').reset();
        document.getElementById('editar_error_nome').textContent = '';
        document.getElementById('editar_error_tema').textContent = '';
    }
    
    // Close on click outside
    window.onclick = function(event) {
        if (event.target == document.getElementById('modalAmbiente')) {
            fecharModalAmbiente();
        }
        if (event.target == document.getElementById('modalEditarAmbiente')) {
            fecharModalEditar();
        }
    }
    
    // Validation handling (server-side errors)
    {% if form.errors and not form_editar %}
    window.addEventListener('DOMContentLoaded', function() {
        abrirModalAmbiente();
        {% if form.nome.errors %}
        document.getElementById('error_nome').textContent = "{{ form.nome.errors|join:', '|escapejs }}";
        {% endif %}
        {% if form.tema.errors %}
        document.getElementById('error_tema').textContent = "{{ form.tema.errors|join:', '|escapejs }}";
        {% endif %}
    });
    {% endif %}
    
    {% if form_editar.errors and ambiente_editar_id %}
    window.addEventListener('DOMContentLoaded', function() {
        abrirModalEditar(
            {{ ambiente_editar_id }},
            "{{ form_editar.nome.value|default:''|escapejs }}",
            "{{ form_editar.tema.value|default:''|escapejs }}"
        );
        {% if form_editar.nome.errors %}
        document.getElementById('editar_error_nome').textContent = "{{ form_editar.nome.errors|join:', '|escapejs }}";
        {% endif %}
        {% if form_editar.tema.errors %}
        document.getElementById('editar_error_tema').textContent = "{{ form_editar.tema.errors|join:', '|escapejs }}";
        {% endif %}
    });
    {% endif %}
</script>
{% endblock %}
