{% extends "global/base.html" %}

{% block titulo %}
    Atividades - {{ ambiente.nome }}
{% endblock %}

{% block content %}
<style>
    body {
        font-family: Arial, sans-serif;
        display: block !important;
        background-color: #181a20;
    }
    .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        margin-bottom: 40px;
    }
        
    /* AGENDA HORIZONTAL */
    .agenda-horizontal {
        background-color: #23262f;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        position: relative;
    }
    .agenda-container {
        overflow-x: auto;
        scroll-behavior: smooth;
    }
    .btn-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: #4f8cff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        cursor: pointer;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(79,140,255,0.4);
        transition: all .2s;
    }
    .btn-nav:hover {
        background: #3a7de8;
        box-shadow: 0 2px 8px rgba(79,140,255,0.6);
    }
    .btn-nav-esquerda {
        left: 10px;
    }
    .btn-nav-direita {
        right: 10px;
    }
    .agenda-scroll {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: center;
        min-width: min-content;
        padding: 10px 0;
    }
    .dia-card {
        background: #292c35;
        border-radius: 8px;
        padding: 12px 16px;
        text-align: center;
        cursor: pointer;
        transition: all .3s ease;
        border: 2px solid transparent;
        min-width: 80px;
        flex-shrink: 0;
        color: #eee;
    }
    .dia-card:hover {
        background: #181a20;
        border-color: #4f8cff;
        box-shadow: 0 4px 8px rgba(79,140,255,0.3);
    }
    .dia-card.hoje {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
        transform: scale(1.15);
        padding: 18px 20px;
        min-width: 100px;
        box-shadow: 0 6px 12px rgba(46,204,113,0.4);
        border-color: #2ecc71;
    }
    .dia-card.hoje:hover {
        transform: scale(1.18) translateY(-2px);
        box-shadow: 0 8px 16px rgba(46,204,113,0.5);
    }
    .dia-card.selecionado {
        background: #4f8cff;
        color: white;
        border-color: #4f8cff;
        transform: scale(1.1);
    }
    .dia-nome {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        opacity: 0.7;
        margin-bottom: 4px;
    }
    .dia-card.hoje .dia-nome,
    .dia-card.selecionado .dia-nome {
        opacity: 0.95;
        font-size: 0.8rem;
    }
    .dia-numero {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 4px 0;
    }
    .dia-card.hoje .dia-numero,
    .dia-card.selecionado .dia-numero {
        font-size: 1.8rem;
    }
    .dia-mes {
        font-size: 0.7rem;
        opacity: 0.6;
        text-transform: uppercase;
    }
    .dia-card.hoje .dia-mes,
    .dia-card.selecionado .dia-mes {
        opacity: 0.9;
        font-size: 0.75rem;
    }
    .dia-atividades {
        font-size: 0.7rem;
        margin-top: 6px;
        padding: 3px 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        font-weight: 600;
    }
    .dia-card.hoje .dia-atividades,
    .dia-card.selecionado .dia-atividades {
        background: rgba(255,255,255,0.25);
    }
    .dia-atividades.zero {
        opacity: 0.4;
    }
        
    /* HEADER */
    .header {
        background-color: #23262f;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        border-left: 4px solid #4f8cff;
        color: #eee;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
    }
    .header-left {
        flex: 1;
    }
    .header h1 {
        margin: 0 0 10px 0;
        color: #4f8cff;
    }
    .header-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .header-right {
        display: flex;
        align-items: center;
    }
    .filtro-icone {
        background: #292c35;
        border: 2px solid #333;
        border-radius: 8px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all .3s ease;
    }
    .filtro-icone:hover {
        background: #4f8cff;
        border-color: #4f8cff;
        transform: scale(1.1);
    }
    .btn {
        padding: 6px 14px;
        background-color: #4f8cff;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        display: inline-block;
        transition: background .2s;
        font-size: 0.9rem;
    }
    .btn:hover {
        background-color: #3a7de8;
        box-shadow: 0 2px 8px rgba(79,140,255,0.3);
    }
    .btn-success {
        background-color: #2ecc71;
    }
    .btn-success:hover {
        background-color: #218838;
    }
    .btn-secondary {
        background-color: #6c757d;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
    }
    
    /* FILTRO ATIVO */
    .filtro-info {
        background-color: #292c35;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #eee;
    }
    .btn-limpar {
        background-color: #dc3545;
        padding: 6px 12px;
        font-size: 0.9rem;
    }
    .btn-limpar:hover {
        background-color: #c82333;
    }
    
    /* TABELA */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: #23262f;
        color: #eee;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    table th, table td {
        border: 1px solid #333;
        padding: 12px;
        text-align: left;
    }
    table th {
        background-color: #181a20;
        font-weight: bold;
        color: #4f8cff;
    }
    table tr:hover {
        background-color: #292c35;
    }
    .vazio {
        text-align: center;
        padding: 40px;
        color: #bbb;
        background-color: #23262f;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .status {
        padding: 5px 10px;
        border-radius: 3px;
        font-weight: bold;
        display: inline-block;
    }
    .status-pendente {
        background-color: #23262f;
        color: #ffc107;
        border: 1px solid #ffc107;
    }
    .status-concluido {
        background-color: #23262f;
        color: #2ecc71;
        border: 1px solid #2ecc71;
    }
    .status-atrasado {
        background-color: #23262f;
        color: #dc3545;
        border: 1px solid #dc3545;
    }
    .paga {
        color: #2ecc71;
        font-weight: bold;
    }
    .nao-paga {
        color: #dc3545;
        font-weight: bold;
    }
    .actions {
        display: flex;
        gap: 5px;
    }
    .actions a {
        padding: 5px 10px;
        font-size: 12px;
    }
    .oculto {
        display: none;
    }
</style>

<div class="container">
    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <h1>üè¢ {{ ambiente.nome }}</h1>
            <div class="header-actions">
                <a href="{% url 'criar_atividade' %}?ambiente_id={{ ambiente.id }}" class="btn btn-success">+ Nova Atividade</a>
                <a href="{% url 'lista_ambientes' %}" class="btn btn-secondary">‚Üê Voltar aos Ambientes</a>
            </div>
        </div>
        
        <div class="header-right">
            <div class="filtro-icone" title="Filtros">
                üîç
            </div>
        </div>
    </div>
    
    <!-- AGENDA HORIZONTAL -->
    <div class="agenda-horizontal">
        <button class="btn-nav btn-nav-esquerda" onclick="navegarAgenda(-7)" title="Semana anterior">‚Äπ</button>
        <button class="btn-nav btn-nav-direita" onclick="navegarAgenda(7)" title="Pr√≥xima semana">‚Ä∫</button>
        <div class="agenda-container" id="agenda-container">
            <div class="agenda-scroll" id="agenda-dias"></div>
        </div>
    </div>
    
    <!-- INFORMA√á√ÉO DE FILTRO -->
    <div id="filtro-info" class="filtro-info oculto">
        <span>Exibindo atividades de: <strong id="data-filtrada"></strong></span>
        <button onclick="limparFiltro()" class="btn btn-limpar">Limpar Filtro</button>
    </div>
    
    <!-- TABELA DE ATIVIDADES -->
    {% if atividades %}
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Hora</th>
                    <th>Descri√ß√£o</th>
                    <th>Valor</th>
                    <th>Status</th>
                    <th>Paga</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tabela-atividades">
                {% for atividade in atividades %}
                    <tr data-data="{{ atividade.data_prevista|date:'Y-m-d' }}">
                        <td><strong>{{ atividade.data_prevista|date:"d/m/Y" }}</strong></td>
                        <td>{{ atividade.hora_prevista|date:"H:i" }}</td>
                        <td>{{ atividade.descricao|truncatewords:15 }}</td>
                        <td>R$ {{ atividade.valor|floatformat:2 }}</td>
                        <td>
                            <span class="status {% if atividade.status == 'Conclu√≠do' %}status-concluido{% elif atividade.status == 'Atrasado' %}status-atrasado{% else %}status-pendente{% endif %}">
                                {{ atividade.status }}
                            </span>
                        </td>
                        <td>
                            <span class="{% if atividade.is_paga %}paga{% else %}nao-paga{% endif %}">
                                {% if atividade.is_paga %}‚úì Paga{% else %}‚úó N√£o Paga{% endif %}
                            </span>
                        </td>
                        <td class="actions">
                            <a href="{% url 'detalhe_atividade' atividade.id %}" class="btn">Ver</a>
                            <a href="{% url 'editar_atividade' atividade.id %}" class="btn btn-success">Editar</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="vazio">
            <p>üì≠ Nenhuma atividade prevista para os pr√≥ximos dias.</p>
            <a href="{% url 'criar_atividade' %}?ambiente_id={{ ambiente.id }}" class="btn btn-success">+ Criar Primeira Atividade</a>
        </div>
    {% endif %}
</div>

<script>
    const atividadesPorDia = {{ atividades_por_dia|safe }};
    let dataFiltrada = null;
    
    function gerarAgenda() {
        const hoje = new Date();
        const container = document.getElementById('agenda-dias');
        const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        
        let html = '';
        
        // Mostrar 60 dias: 30 dias antes e 30 dias depois
        for (let i = -30; i <= 30; i++) {
            const data = new Date(hoje);
            data.setDate(hoje.getDate() + i);
            
            const diaSemana = diasSemana[data.getDay()];
            const dia = data.getDate();
            const mes = meses[data.getMonth()];
            const isHoje = i === 0;
            
            const dataISO = data.toISOString().split('T')[0];
            const numAtividades = atividadesPorDia[dataISO] || 0;
            
            html += `
                <div class="dia-card ${isHoje ? 'hoje' : ''}" data-data="${dataISO}" onclick="filtrarPorDia('${dataISO}', '${dia}/${mes}')">
                    <div class="dia-nome">${diaSemana}</div>
                    <div class="dia-numero">${dia}</div>
                    <div class="dia-mes">${mes}</div>
                    <div class="dia-atividades ${numAtividades === 0 ? 'zero' : ''}">
                        ${numAtividades === 0 ? '‚Ä¢' : numAtividades}
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
        
        setTimeout(() => {
            const diaHoje = container.querySelector('.dia-card.hoje');
            if (diaHoje) {
                diaHoje.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
            
            // Filtrar automaticamente pelo dia corrente
            const hojeISO = hoje.toISOString().split('T')[0];
            const dia = hoje.getDate();
            const mes = meses[hoje.getMonth()];
            filtrarPorDia(hojeISO, `${dia}/${mes}`);
        }, 100);
    }
    
    function filtrarPorDia(data, dataFormatada) {
        dataFiltrada = data;
        
        // Remove sele√ß√£o anterior
        document.querySelectorAll('.dia-card').forEach(card => {
            card.classList.remove('selecionado');
        });
        
        // Adiciona sele√ß√£o ao dia clicado
        const diaClicado = document.querySelector(`.dia-card[data-data="${data}"]`);
        if (diaClicado && !diaClicado.classList.contains('hoje')) {
            diaClicado.classList.add('selecionado');
        }
        
        // Mostra informa√ß√£o de filtro
        document.getElementById('filtro-info').classList.remove('oculto');
        document.getElementById('data-filtrada').textContent = dataFormatada;
        
        // Filtra as linhas da tabela
        const linhas = document.querySelectorAll('#tabela-atividades tr');
        let encontrouAtividades = false;
        
        linhas.forEach(linha => {
            const dataLinha = linha.getAttribute('data-data');
            if (dataLinha === data) {
                linha.style.display = '';
                encontrouAtividades = true;
            } else {
                linha.style.display = 'none';
            }
        });
        
        // Se n√£o houver atividades para o dia, mostra mensagem
        // if (!encontrouAtividades) {
        //     alert('N√£o h√° atividades para este dia.');
        // }
    }
    
    function limparFiltro() {
        dataFiltrada = null;
        
        // Remove todas as sele√ß√µes
        document.querySelectorAll('.dia-card').forEach(card => {
            card.classList.remove('selecionado');
        });
        
        // Esconde informa√ß√£o de filtro
        document.getElementById('filtro-info').classList.add('oculto');
        
        // Mostra todas as linhas da tabela
        const linhas = document.querySelectorAll('#tabela-atividades tr');
        linhas.forEach(linha => {
            linha.style.display = '';
        });
    }
    
    function navegarAgenda(dias) {
        const container = document.getElementById('agenda-container');
        const cardWidth = 104; // largura aproximada do card + gap
        const scrollAmount = cardWidth * dias;
        container.scrollBy({
            left: scrollAmount,
            behavior: 'smooth'
        });
    }
    
    window.addEventListener('DOMContentLoaded', gerarAgenda);
</script>
{% endblock %}