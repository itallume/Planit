{% extends "global/base.html" %}

{% block titulo %}
    Atividades
{% endblock %}

{% block content %}
<style>
    {% if ambiente.tema %}
    :root {
        --ambiente-theme-color: {{ ambiente.tema }};
        --ambiente-theme-color-alpha: {{ ambiente.tema }}33;
    }
    {% endif %}
    
    .container-atividades {
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 100%;
        padding: 40px 20px;
    }

    .page-header {
        display: flex;
        width: 100%;
        justify-content: space-around;
        align-items: center;
        margin-bottom: 40px;
        gap: 40px;
    }

    .header-text h1 {
        font-size: 2rem;
        color: var(--ambiente-theme-color, var(--text-light));
        margin: 0 0 12px 0;
        font-weight: 700;
        text-align: center;
    }

    .header-text p {
        margin: 0;
        color: var(--green-light);
        font-size: 1.05rem;
        opacity: 0.9;
    }

    .btn-nova-atividade {
        background-color: var(--ambiente-theme-color, var(--primary-orange));
        color: white;
        padding: 12px 24px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        transition: transform 0.1s, opacity 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 4px rgba(242, 104, 0, 0.3);
        white-space: nowrap;
    }

    .btn-nova-atividade:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }

    .btn-adicionar-colaborador {
        background-color: rgba(163, 204, 171, 0.15);
        color: var(--green-light);
        padding: 12px 24px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        border: 1px solid rgba(163, 204, 171, 0.3);
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .btn-adicionar-colaborador:hover {
        background-color: rgba(163, 204, 171, 0.25);
        transform: translateY(-1px);
    }

    .btn-voltar-ambiente {
        background: rgba(163, 204, 171, 0.1);
        color: var(--text-light);
        border: 1px solid rgba(163, 204, 171, 0.3);
        padding: 12px 24px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .btn-voltar-ambiente:hover {
        background: rgba(163, 204, 171, 0.2);
        transform: translateY(-1px);
    }

    /* Calendar Section */
    .calendar-section {
        width: 80%;
        background: #1a1a16;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.3);
        border: 1px solid rgba(163, 204, 171, 0.15);
        position: relative;
    }

    .calendar-header {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
    }

    .month-year {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--text-light);
    }

    .calendar-scroll-container {
        overflow-x: auto;
        overflow-y: hidden;
        position: relative;
        scroll-behavior: smooth;
        padding: 10px 0;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }

    .calendar-scroll-container::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }

    .calendar-grid {
        display: flex;
        gap: 12px;
        min-width: min-content;
        transition: none;
    }

    .day-card {
        min-width: 120px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(163, 204, 171, 0.05);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        position: relative;
        padding: 20px 16px;
    }

    .day-card:hover {
        background: rgba(242, 104, 0, 0.1);
        border-color: var(--ambiente-theme-color, var(--primary-orange));
        transform: translateY(-4px);
    }

    .day-card.today {
        background: var(--ambiente-theme-color, var(--primary-orange));
        color: white;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(242, 104, 0, 0.4);
    }

    .day-card.today:hover {
        transform: translateY(-4px);
    }

    .day-card.has-activity {
        border-color: var(--green-light);
    }

    .day-card.has-activity::after {
        content: '';
        position: absolute;
        bottom: 8px;
        width: 8px;
        height: 8px;
        background: var(--green-light);
        border-radius: 50%;
    }

    .day-card.today.has-activity::after {
        background: white;
    }

    .day-name {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: rgba(163, 204, 171, 0.7);
        margin-bottom: 8px;
        font-weight: 600;
    }

    .day-card.today .day-name {
        color: rgba(255, 255, 255, 0.9);
    }

    .day-number {
        font-size: 2rem;
        color: var(--text-light);
        font-weight: 700;
        margin-bottom: 4px;
    }

    .day-card.today .day-number {
        color: white;
    }

    .day-month {
        font-size: 0.8rem;
        color: rgba(163, 204, 171, 0.6);
        text-transform: uppercase;
    }

    .day-card.today .day-month {
        color: rgba(255, 255, 255, 0.8);
    }

    .activity-count {
        font-size: 0.75rem;
        color: var(--green-light);
        margin-top: 8px;
        padding: 4px 8px;
        background: rgba(163, 204, 171, 0.15);
        border-radius: 10px;
        font-weight: 600;
    }

    .day-card.today .activity-count {
        color: white;
        background: rgba(255, 255, 255, 0.25);
    }

    .day-card.selected {
        background: rgba(163, 204, 171, 0.2);
        border-color: var(--green-light);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(163, 204, 171, 0.3);
    }

    .day-card.selected .day-name {
        color: var(--green-light);
    }

    .day-card.selected .day-number {
        color: var(--text-light);
    }

    .day-card.selected .day-month {
        color: var(--green-light);
    }

    .day-card.selected .activity-count {
        background: rgba(163, 204, 171, 0.3);
        color: var(--green-light);
    }

    /* Today takes priority over selected */
    .day-card.today.selected {
        background: var(--ambiente-theme-color, var(--primary-orange));
        border-color: var(--ambiente-theme-color, var(--primary-orange));
    }

    .day-card.today.selected .day-name,
    .day-card.today.selected .day-number,
    .day-card.today.selected .day-month {
        color: white;
    }

    .day-card.today.selected .activity-count {
        color: white;
        background: rgba(255, 255, 255, 0.25);
    }

    /* Activities List */
    .activities-section {
        width: 80%;
    }

    .activities-header {
        font-size: 1.3rem;
        color: var(--text-light);
        margin-bottom: 20px;
        font-weight: 600;
    }

    .activity-day-group {
        margin-bottom: 30px;
    }

    .day-title {
        font-size: 1.1rem;
        color: var(--green-light);
        margin-bottom: 15px;
        font-weight: 600;
        padding-bottom: 8px;
        border-bottom: 2px solid rgba(163, 204, 171, 0.3);
    }

    .activities-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .activity-card {
        background: #1a1a16;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid rgba(163, 204, 171, 0.15);
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .activity-card:hover {
        border-color: var(--primary-orange);
        box-shadow: 0 4px 12px rgba(242, 104, 0, 0.15);
    }

    .activity-info {
        flex: 1;
    }

    .activity-description {
        color: var(--text-light);
        font-size: 1rem;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .activity-meta {
        display: flex;
        gap: 20px;
        font-size: 0.9rem;
        color: rgba(163, 204, 171, 0.7);
    }

    .activity-actions {
        display: flex;
        gap: 8px;
    }

    .btn-action {
        padding: 6px 12px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        transition: opacity 0.2s;
        border: none;
        cursor: pointer;
    }

    .btn-view {
        background: var(--ambiente-theme-color, var(--green-medium));
        color: white;
    }

    .btn-edit {
        background: var(--ambiente-theme-color, var(--primary-orange));
        color: white;
    }

    .btn-action:hover {
        opacity: 0.8;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-completed {
        background: rgba(16, 185, 129, 0.2);
        color: var(--status-completed);
    }

    .status-pending {
        background: rgba(245, 158, 11, 0.2);
        color: var(--status-pending);
    }

    .status-delayed {
        background: rgba(239, 68, 68, 0.2);
        color: var(--status-delayed);
    }

    .empty-state {
        text-align: center;
        padding: 60px;
        background: #1a1a16;
        border-radius: 12px;
        color: rgba(163, 204, 171, 0.7);
        border: 2px dashed rgba(163, 204, 171, 0.3);
    }

    .header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .btn-configurar-ambiente {
        background: rgba(163, 204, 171, 0.1);
        color: var(--text-light);
        border: 1px solid rgba(163, 204, 171, 0.3);
        padding: 12px 16px;
        border-radius: 6px;
        text-decoration: none;
        cursor: pointer;
        font-size: 1.1rem;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    }

    .btn-configurar-ambiente:hover {
        background: rgba(163, 204, 171, 0.2);
        transform: translateY(-1px) rotate(90deg);
        color: var(--green-light);
    }

    .btn-configurar-ambiente i {
        transition: transform 0.2s ease;
    }

    /* Mini Calendar */
    .mini-calendar-toggle {
        position: absolute;
        top: 30px;
        right: 30px;
        background: rgba(163, 204, 171, 0.1);
        border: 1px solid rgba(163, 204, 171, 0.3);
        color: var(--text-light);
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .mini-calendar-toggle:hover {
        background: rgba(163, 204, 171, 0.2);
    }

    .mini-calendar-container {
        display: none;
        position: absolute;
        top: 80px;
        right: 30px;
        background: #16160f;
        border: 1px solid rgba(163, 204, 171, 0.3);
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        z-index: 100;
        min-width: 280px;
    }

    .mini-calendar-container.show {
        display: block;
    }

    .mini-calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .mini-calendar-header h3 {
        color: var(--green-light);
        margin: 0;
        font-size: 1rem;
    }

    .mini-calendar-nav {
        display: flex;
        gap: 8px;
    }

    .mini-calendar-nav button {
        background: rgba(163, 204, 171, 0.1);
        border: 1px solid rgba(163, 204, 171, 0.3);
        color: var(--text-light);
        width: 32px;
        height: 32px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mini-calendar-nav button:hover {
        background: rgba(163, 204, 171, 0.2);
    }

    .mini-calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-bottom: 8px;
    }

    .mini-calendar-weekday {
        text-align: center;
        color: rgba(163, 204, 171, 0.6);
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 0;
    }

    .mini-calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
    }

    .mini-calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        color: var(--text-light);
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .mini-calendar-day:hover {
        background: rgba(163, 204, 171, 0.1);
    }

    .mini-calendar-day.other-month {
        color: rgba(163, 204, 171, 0.3);
    }

    .mini-calendar-day.today {
        background: var(--primary-orange);
        color: white;
        font-weight: 700;
    }

    .mini-calendar-day.selected {
        border-color: var(--green-light);
        background: rgba(163, 204, 171, 0.2);
    }

    .mini-calendar-day.has-activity::after {
        content: '';
        position: absolute;
        bottom: 2px;
        width: 4px;
        height: 4px;
        background: var(--green-light);
        border-radius: 50%;
    }
</style>

<div class="container-atividades">
    <div class="page-header">
        <a href="{% url 'lista_ambientes' %}" class="btn-voltar-ambiente">
            <i class="fas fa-arrow-left"></i>
            Ambientes
        </a>
        <div class="header-text">
            <h1>Atividades</h1>
            <p>Visualize e gerencie suas atividades por dia</p>
        </div>
        <div class="header-actions">
            <a href="{% url 'configurar_ambiente' ambiente.id %}" class="btn-configurar-ambiente" title="Configurar Ambiente">
                <i class="fas fa-cog"></i>
            </a>
            {% if user_permissions.pode_criar_atividades %}
            <a href="{% url 'criar_atividade' %}?ambiente_id={{ ambiente.id }}" id="btnNovaAtividade" class="btn-nova-atividade">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Nova Atividade
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Calendar Section -->
    <div class="calendar-section">
        <div class="calendar-header">
            <span class="month-year" id="monthYear"></span>
        </div>

        <button class="mini-calendar-toggle" onclick="toggleMiniCalendar()">
            <i class="fas fa-calendar-alt"></i>
            Ir para data
        </button>

        <div class="mini-calendar-container" id="miniCalendar">
            <div class="mini-calendar-header">
                <h3 id="miniCalendarMonth"></h3>
                <div class="mini-calendar-nav">
                    <button onclick="changeMiniCalendarMonth(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button onclick="changeMiniCalendarMonth(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="mini-calendar-weekdays">
                <div class="mini-calendar-weekday">Dom</div>
                <div class="mini-calendar-weekday">Seg</div>
                <div class="mini-calendar-weekday">Ter</div>
                <div class="mini-calendar-weekday">Qua</div>
                <div class="mini-calendar-weekday">Qui</div>
                <div class="mini-calendar-weekday">Sex</div>
                <div class="mini-calendar-weekday">Sáb</div>
            </div>
            <div class="mini-calendar-days" id="miniCalendarDays">
                <!-- Days will be generated by JavaScript -->
            </div>
        </div>

        <div class="calendar-scroll-container">
            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Activities List -->
    <div class="activities-section">
        <h2 class="activities-header" id="activitiesHeader">Atividades</h2>
        
        <div id="activitiesList">
            {% if atividades %}
                {% for atividade in atividades %}
                <div class="activity-card" data-date="{{ atividade.data_prevista|date:'Y-m-d' }}">
                    <div class="activity-info">
                        <div class="activity-description">{{ atividade.descricao|truncatewords:15 }}</div>
                        <div class="activity-meta">
                            <span><i class="far fa-clock"></i> {{ atividade.hora_prevista|date:"H:i" }}</span>
                            <span><i class="fas fa-dollar-sign"></i> R$ {{ atividade.valor|floatformat:2 }}</span>
                            <span class="status-badge {% if atividade.status == 'Concluído' %}status-completed{% elif atividade.status == 'Atrasado' %}status-delayed{% else %}status-pending{% endif %}">
                                {{ atividade.status }}
                            </span>
                        </div>
                    </div>
                    <div class="activity-actions">
                        <a href="{% url 'detalhe_atividade' atividade.id %}" class="btn-action btn-view">Ver</a>
                        {% if user_permissions.pode_editar_atividades %}
                        <a href="{% url 'editar_atividade' atividade.id %}" class="btn-action btn-edit">Editar</a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state" id="emptyState">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="rgba(163, 204, 171, 0.5)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 16px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <p>Nenhuma atividade para este dia.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    const atividadesPorDia = {{ atividades_por_dia|safe }};
    const baseDateFromBackend = "{{ base_date }}"; // Data base do backend
    const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const monthNamesShort = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
    let selectedDate = null;
    let currentBaseDate = baseDateFromBackend ? new Date(baseDateFromBackend + 'T00:00:00') : new Date(); // Data base para o calendário horizontal
    let miniCalendarDate = new Date(); // Data do mini calendário

    function renderCalendar(baseDate = null) {
        if (baseDate) {
            currentBaseDate = new Date(baseDate);
        }
        
        // Update header with current month/year
        const month = currentBaseDate.getMonth();
        const year = currentBaseDate.getFullYear();
        document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;
        
        // Generate days: 30 days before and 30 days after base date
        let html = '';
        
        for (let i = -30; i <= 30; i++) {
            const date = new Date(currentBaseDate);
            date.setDate(currentBaseDate.getDate() + i);
            
            const dayName = dayNames[date.getDay()];
            const dayNum = date.getDate();
            const monthShort = monthNamesShort[date.getMonth()];
            
            // Format date as YYYY-MM-DD for comparison
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            const isToday = dateStr === getTodayDateStr();
            const activityCount = atividadesPorDia[dateStr] || 0;
            const hasActivity = activityCount > 0;
            
            html += `
                <div class="day-card ${isToday ? 'today' : ''} ${hasActivity ? 'has-activity' : ''}" 
                     data-date="${dateStr}" onclick="selectDay('${dateStr}', ${dayNum}, '${monthShort}')">
                    <div class="day-name">${dayName}</div>
                    <div class="day-number">${dayNum}</div>
                    <div class="day-month">${monthShort}</div>
                    ${activityCount > 0 ? `<div class="activity-count">${activityCount} atividade${activityCount > 1 ? 's' : ''}</div>` : ''}
                </div>
            `;
        }
        
        document.getElementById('calendarGrid').innerHTML = html;
        
        // Scroll to base date's card after rendering
        setTimeout(() => {
            const baseDateStr = currentBaseDate.toISOString().split('T')[0];
            const baseCard = document.querySelector(`.day-card[data-date="${baseDateStr}"]`);
            if (baseCard) {
                baseCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }, 100);
    }


    function selectDay(dateStr, day, month) {
        selectedDate = dateStr;
        
        // Update month/year header based on selected date
        const clickedDate = new Date(dateStr);
        const monthIndex = clickedDate.getMonth();
        const year = clickedDate.getFullYear();
        document.getElementById('monthYear').textContent = `${monthNames[monthIndex]} ${year}`;
        
        // Remove previous selection from all cards
        document.querySelectorAll('.day-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Add selected class to clicked day (always, even if it's today)
        const clickedCard = document.querySelector(`.day-card[data-date="${dateStr}"]`);
        if (clickedCard) {
            clickedCard.classList.add('selected');
        }
        
        // Scroll the clicked card to center
        if (clickedCard) {
            clickedCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
        
        // Update activities header
        document.getElementById('activitiesHeader').textContent = `Atividades para ${day} de ${month}`;
        
        // Update "Nova Atividade" button to include data_prevista
        const btnNovaAtividade = document.getElementById('btnNovaAtividade');
        if (btnNovaAtividade) {
            const baseUrl = `{% url 'criar_atividade' %}?ambiente_id={{ ambiente.id }}`;
            btnNovaAtividade.href = `${baseUrl}&data_prevista=${dateStr}`;
        }
        
        // Filter activities by selected date
        filterActivities(dateStr);
    }

    function filterActivities(dateStr) {
        const activityCards = document.querySelectorAll('.activity-card');
        let hasVisibleActivities = false;
        
        activityCards.forEach(card => {
            const cardDate = card.getAttribute('data-date');
            if (cardDate === dateStr) {
                card.style.display = 'flex';
                hasVisibleActivities = true;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Show/hide empty state
        const emptyState = document.getElementById('emptyState');
        if (emptyState) {
            emptyState.style.display = hasVisibleActivities ? 'none' : 'block';
        } else if (!hasVisibleActivities) {
            // Create empty state if it doesn't exist
            const activitiesList = document.getElementById('activitiesList');
            const emptyStateHTML = `
                <div class="empty-state" id="emptyState">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="rgba(163, 204, 171, 0.5)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 16px;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <p>Nenhuma atividade para este dia.</p>
                </div>
            `;
            activitiesList.insertAdjacentHTML('beforeend', emptyStateHTML);
        }
    }

    // Helper function to get today's date string
    function getTodayDateStr() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Mini Calendar Functions
    function toggleMiniCalendar() {
        const miniCal = document.getElementById('miniCalendar');
        miniCal.classList.toggle('show');
        if (miniCal.classList.contains('show')) {
            renderMiniCalendar();
        }
    }

    function changeMiniCalendarMonth(delta) {
        miniCalendarDate.setMonth(miniCalendarDate.getMonth() + delta);
        renderMiniCalendar();
    }

    function renderMiniCalendar() {
        const year = miniCalendarDate.getFullYear();
        const month = miniCalendarDate.getMonth();
        
        // Update header
        document.getElementById('miniCalendarMonth').textContent = 
            `${monthNames[month]} ${year}`;
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        // Get previous month's last days
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        
        let html = '';
        const todayStr = getTodayDateStr();
        
        // Previous month's days
        for (let i = startingDayOfWeek - 1; i >= 0; i--) {
            const day = prevMonthLastDay - i;
            html += `<div class="mini-calendar-day other-month">${day}</div>`;
        }
        
        // Current month's days
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = dateStr === todayStr;
            const isSelected = dateStr === selectedDate;
            const hasActivity = atividadesPorDia[dateStr] > 0;
            
            html += `
                <div class="mini-calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''} ${hasActivity ? 'has-activity' : ''}"
                     onclick="jumpToDate('${dateStr}')">
                    ${day}
                </div>
            `;
        }
        
        // Next month's days to fill the grid
        const totalCells = Math.ceil((startingDayOfWeek + daysInMonth) / 7) * 7;
        const remainingCells = totalCells - (startingDayOfWeek + daysInMonth);
        for (let day = 1; day <= remainingCells; day++) {
            html += `<div class="mini-calendar-day other-month">${day}</div>`;
        }
        
        document.getElementById('miniCalendarDays').innerHTML = html;
    }

    function jumpToDate(dateStr) {
        // Recarregar a página com o novo base_date
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('base_date', dateStr);
        window.location.href = currentUrl.toString();
    }

    // Close mini calendar when clicking outside
    document.addEventListener('click', function(event) {
        const miniCal = document.getElementById('miniCalendar');
        const toggle = document.querySelector('.mini-calendar-toggle');
        
        if (miniCal && toggle && 
            !miniCal.contains(event.target) && 
            !toggle.contains(event.target) &&
            miniCal.classList.contains('show')) {
            miniCal.classList.remove('show');
        }
    });

    // Initialize calendar on page load
    document.addEventListener('DOMContentLoaded', function() {
        renderCalendar();
        renderMiniCalendar();
        
        // Auto-select base date
        setTimeout(() => {
            const baseDateStr = currentBaseDate.toISOString().split('T')[0];
            const dayNum = currentBaseDate.getDate();
            const monthShort = monthNamesShort[currentBaseDate.getMonth()];
            selectDay(baseDateStr, dayNum, monthShort);
        }, 100);
    });
</script>

{% endblock %}
