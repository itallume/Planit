{% extends "global/base.html" %}

{% block titulo %}
    {% if atividade %}Editar{% else %}Criar{% endif %} Atividade
{% endblock %}

{% block content %}

<style>
       body {
        font-family: Arial, sans-serif;
        /* margin: 20px; */
        display: block !important; /* sobrescreve o flex l√° do carinha */
        /* margin: 20px !important; */
    }
    .container {
        max-width: 900px;
        margin: 0 auto;
    }
    .section {
        background-color: #292c35;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        border-left: 4px solid #4f8cff;
        color: #eee;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .section h2 {
        margin-top: 0;
        color: #4f8cff;
    }
    form {
        margin: 0;
    }
    .form-group {
        margin-bottom: 15px;
        margin-top: 5px;
    }
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #eee;
    }
    input, select, textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #333;
        border-radius: 4px;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
        background: #181a20;
        color: #eee;
    }
    textarea {
        resize: vertical;
    }
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    .form-row .form-group {
        margin-bottom: 0;
    }
    .formset {
        background-color: #23262f;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
        color: #eee;
    }
    .formset-form {
        background-color: #181a20;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #333;
        border-radius: 4px;
        color: #eee;
    }
    .formset-form .form-row {
        grid-template-columns: 1fr 1fr 1fr;
    }
    .formset-form .delete-row {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 10px;
    }
    .checkbox-group {
        display: flex;
        align-items: center;
    }
    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
    }
    .management-form {
        display: none;
    }
    .add-form-btn {
        background-color: #4f8cff;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 10px;
    }
    .add-form-btn:hover {
        background-color: #2ecc71;
    }
    .buttons {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #222;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    button {
        background-color: #2ecc71;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
        transition: background .2s;
    }
    button:hover {
        background-color: #218838;
    }
    .btn-voltar {
        background-color: #4f8cff;
    }
    .btn-voltar:hover {
        background-color: #23262f;
        color: #fff;
    }
</style>

<div class="container">
    <h1>{% if atividade %}Editar Atividade{% else %}Criar Nova Atividade{% endif %}</h1>
    
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Se√ß√£o de Atividade -->
        <div class="section">
            <h2>üìã Informa√ß√µes da Atividade</h2>
            <div class="form-group">
                {{ atividade_form.descricao.label_tag }}
                {{ atividade_form.descricao }}
            </div>
            <div class="form-row">
                <div class="form-group">
                    {{ atividade_form.valor.label_tag }}
                    {{ atividade_form.valor }}
                </div>
                <div class="form-group">
                    {{ atividade_form.valor_recebido.label_tag }}
                    {{ atividade_form.valor_recebido }}
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    {{ atividade_form.data_prevista.label_tag }}
                    {{ atividade_form.data_prevista }}
                </div>
                <div class="form-group">
                    {{ atividade_form.status.label_tag }}
                    {{ atividade_form.status }}
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    {{ atividade_form.ambiente.label_tag }}
                    {{ atividade_form.ambiente }}
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        {{ atividade_form.is_paga }}
                        {{ atividade_form.is_paga.label_tag }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o de Cliente -->
        <div class="section">
            <h2>üë§ Informa√ß√µes do Cliente</h2>
            <div class="form-row">
                <div class="form-group">
                    {{ cliente_form.nome.label_tag }}
                    {{ cliente_form.nome }}
                </div>
                <div class="form-group">
                    {{ cliente_form.email.label_tag }}
                    {{ cliente_form.email }}
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    {{ cliente_form.telefone.label_tag }}
                    {{ cliente_form.telefone }}
                </div>
            </div>
            <div class="form-group">
                {{ cliente_form.sobre.label_tag }}
                {{ cliente_form.sobre }}
            </div>
        </div>
        
        <!-- Se√ß√£o de Endere√ßos -->
        <div class="section">
            <h2>üìç Endere√ßos do Cliente</h2>
            {{ endereco_formset.management_form }}
            <div id="enderecos-container" class="formset">
                {% for form in endereco_formset %}
                    <div class="formset-form" data-form-index="{{ forloop.counter0 }}">
                        <div class="form-row">
                            <div class="form-group">{{ form.rua.label_tag }} {{ form.rua }}</div>
                            <div class="form-group">{{ form.cidade.label_tag }} {{ form.cidade }}</div>
                            <div class="form-group">{{ form.estado.label_tag }} {{ form.estado }}</div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">{{ form.cep.label_tag }} {{ form.cep }}</div>
                            <div class="form-group">{{ form.complemento.label_tag }} {{ form.complemento }}</div>
                            <div class="form-group delete-row">
                                {{ form.DELETE }} <button type="button" class="btn-remove">Remover</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-endereco" class="add-form-btn">+ Endere√ßo</button>
            <template id="endereco-prototype">
                <div class="formset-form" data-form-index="__index__">
                    <div class="form-row">
                        <div class="form-group">
                            {{ endereco_formset.empty_form.rua.label_tag }}
                            {{ endereco_formset.empty_form.rua }}
                        </div>
                        <div class="form-group">
                            {{ endereco_formset.empty_form.cidade.label_tag }}
                            {{ endereco_formset.empty_form.cidade }}
                        </div>
                        <div class="form-group">
                            {{ endereco_formset.empty_form.estado.label_tag }}
                            {{ endereco_formset.empty_form.estado }}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            {{ endereco_formset.empty_form.cep.label_tag }}
                            {{ endereco_formset.empty_form.cep }}
                        </div>
                        <div class="form-group">
                            {{ endereco_formset.empty_form.complemento.label_tag }}
                            {{ endereco_formset.empty_form.complemento }}
                        </div>
                        <div class="form-group delete-row">
                            {{ endereco_formset.empty_form.DELETE }}
                            <button type="button" class="btn-remove">Remover</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Se√ß√£o de Refer√™ncias -->
        <div class="section">
            <h2>üìé Refer√™ncias Visuais</h2>
            {{ referencia_formset.management_form }}
            <div id="referencias-container" class="formset">
                {% for form in referencia_formset %}
                    <div class="formset-form" data-form-index="{{ forloop.counter0 }}">
                        <div class="form-row">
                            <div class="form-group">{{ form.tipo.label_tag }} {{ form.tipo }}</div>
                            <div class="form-group">{{ form.nome_arquivo.label_tag }} {{ form.nome_arquivo }}</div>
                            <div class="form-group">{{ form.arquivo.label_tag }} {{ form.arquivo }}</div>
                        </div>
                        <div class="form-group delete-row">
                            {{ form.DELETE }} <button type="button" class="btn-remove">Remover</button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-referencia" class="add-form-btn">+ Refer√™ncia</button>
            <template id="referencia-prototype">
                <div class="formset-form" data-form-index="__index__">
                    <div class="form-row">
                        <div class="form-group">
                            {{ referencia_formset.empty_form.tipo.label_tag }}
                            {{ referencia_formset.empty_form.tipo }}
                        </div>
                        <div class="form-group">
                            {{ referencia_formset.empty_form.nome_arquivo.label_tag }}
                            {{ referencia_formset.empty_form.nome_arquivo }}
                        </div>
                        <div class="form-group">
                            {{ referencia_formset.empty_form.arquivo.label_tag }}
                            {{ referencia_formset.empty_form.arquivo }}
                        </div>
                    </div>
                    <div class="form-group delete-row">
                        {{ referencia_formset.empty_form.DELETE }}
                        <button type="button" class="btn-remove">Remover</button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Bot√µes -->
        <div class="section buttons">
            <button type="submit">Salvar</button>
            <a href="{% url 'lista_atividades' %}"><button type="button" class="btn-voltar">Voltar</button></a>
        </div>
    </form>
</div>

<script>
(function() {
    function initFormset(prefix, addBtnId, containerId, protoId) {
        const addBtn = document.getElementById(addBtnId);
        const container = document.getElementById(containerId);
        const template = document.getElementById(protoId);
        const totalInput = document.getElementById('id_' + prefix + '-TOTAL_FORMS');

        addBtn.addEventListener('click', () => {
            const index = parseInt(totalInput.value, 10);
            let html = template.innerHTML.replace(/__prefix__/g, index).replace(/__index__/g, index);
            container.insertAdjacentHTML('beforeend', html);
            totalInput.value = index + 1;
        });

        container.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-remove')) {
                const formDiv = e.target.closest('.formset-form');
                const delBox = formDiv.querySelector('input[type="checkbox"][name$="-DELETE"]');
                if (delBox) {
                    delBox.checked = true;
                    formDiv.style.display = 'none';
                } else {
                    formDiv.remove();
                }
            }
        });
    }
    initFormset('endereco', 'add-endereco', 'enderecos-container', 'endereco-prototype');
    initFormset('referencia', 'add-referencia', 'referencias-container', 'referencia-prototype');
})();
</script>
{% endblock %}